version: '3.8'

services:
  # Grafana MCP Server (Official Image)
  mcp-server:
    image: grafana/mcp-grafana:latest
    container_name: grafana-mcp-server-dev
    environment:
      - GRAFANA_URL=${GRAFANA_URL}
      - GRAFANA_SERVICE_ACCOUNT_TOKEN=${GRAFANA_TOKEN}
      - GRAFANA_TOKEN=${GRAFANA_TOKEN}
    command: ["--transport", "streamable-http", "--address", "0.0.0.0:8888"]
    ports:
      - "8888:8888"
    restart: unless-stopped
    networks:
      - grafana-agent-network

  # Python Agent Backend (with hot-reload)
  agent:
    build:
      context: ./sm3_agent
      dockerfile: Dockerfile
    container_name: grafana-agent-backend-dev
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - MCP_SERVER_URL=http://mcp-server:8888/mcp
      - GRAFANA_URL=${GRAFANA_URL}
      - GRAFANA_TOKEN=${GRAFANA_TOKEN}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - CORS_ORIGINS=http://localhost:3000
      - SERVICE=backend
      - BACKEND_PORT=8000
    ports:
      - "8000:8000"
    volumes:
      - ./sm3_agent/backend:/app/backend
    depends_on:
      - mcp-server
    command: uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --reload
    restart: unless-stopped
    networks:
      - grafana-agent-network

  # React Frontend (with Vite dev server)
  frontend:
    image: node:18-alpine
    container_name: grafana-agent-frontend-dev
    working_dir: /app
    environment:
      - VITE_API_URL=http://localhost:8000
    ports:
      - "3000:3000"
    volumes:
      - ./frontend/web:/app
      - /app/node_modules
    depends_on:
      - agent
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    restart: unless-stopped
    networks:
      - grafana-agent-network

networks:
  grafana-agent-network:
    driver: bridge
