# SM3 Agent - Docker Compose
# Development environment with hot-reload
#
# Usage:
#   docker compose up -d          # Start all services
#   docker compose up -d agent    # Start backend only
#   docker compose logs -f agent  # View backend logs
#
# See docs/DOCKER.md for full documentation

services:
  # Grafana MCP Server (Official Image)
  mcp-grafana:
    image: grafana/mcp-grafana:latest
    container_name: grafana-mcp-server-dev
    environment:
      - GRAFANA_URL=${GRAFANA_URL}
      - GRAFANA_SERVICE_ACCOUNT_TOKEN=${GRAFANA_TOKEN}
    command: ["--transport", "streamable-http", "--address", "0.0.0.0:8888", "--debug"]
    ports:
      - "8888:8888"
    restart: unless-stopped
    networks:
      - sm3-network

  # Python Agent Backend
  agent:
    build:
      context: ./sm3_agent
      dockerfile: Dockerfile
    container_name: grafana-agent-backend-dev
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - MCP_SERVER_URL=http://mcp-grafana:8888/mcp
      - GRAFANA_URL=${GRAFANA_URL}
      - GRAFANA_PUBLIC_URL=${GRAFANA_PUBLIC_URL:-${GRAFANA_URL}}
      - GRAFANA_TOKEN=${GRAFANA_TOKEN}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3100,http://localhost:3000}
      - KB_DIR=/data/kb
      - ALERT_ANALYSIS_DIR=/data/alert-analyses
    ports:
      - "8000:8000"
    volumes:
      - ./sm3_agent/backend:/app/backend:ro
      - ./sm3_agent/mcp_servers.json:/app/mcp_servers.json:ro
      - ./kb:/data/kb:ro
      - ./alert-analyses:/data/alert-analyses
    depends_on:
      - mcp-grafana
    restart: unless-stopped
    networks:
      - sm3-network

  # React Frontend
  frontend:
    build:
      context: ./frontend/web
      dockerfile: Dockerfile
    container_name: grafana-agent-frontend-dev
    ports:
      - "3100:3000"
    environment:
      - VITE_API_URL=http://localhost:8000
    depends_on:
      - agent
    restart: unless-stopped
    networks:
      - sm3-network

networks:
  sm3-network:
    driver: bridge
    name: sm3-mcp-network
